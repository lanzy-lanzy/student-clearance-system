{% extends 'admin/base_admin.html' %}

{% block title %}Dormitory Owner Management{% endblock %}

{% block extra_head %}
<script>
    // Add Modal Functions
    function openAddModal() {
        console.log('Opening add modal');
        document.getElementById('addModal').classList.remove('hidden');
    }

    function closeAddModal() {
        console.log('Closing add modal');
        document.getElementById('addModal').classList.add('hidden');
        document.getElementById('addForm').reset();
    }

    // Edit Modal Functions
    function editDormitoryOwner(id, name, role) {
        document.getElementById('editStaffId').value = id;
        document.getElementById('editName').textContent = name;
        document.getElementById('editRole').value = role;
        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('editForm').reset();
    }

    // Delete Modal Functions
    function confirmDelete(id, name, studentCount) {
        document.getElementById('deleteStaffId').value = id;

        let warningMessage = `Are you sure you want to delete dormitory owner "${name}"?`;

        if (studentCount > 0) {
            warningMessage += `<br><br><strong class="text-red-600">Warning:</strong> This dormitory owner has ${studentCount} student(s) assigned. You will need to use Force Delete to remove this dormitory owner.`;
            document.getElementById('deleteForce').checked = true;
        } else {
            document.getElementById('deleteSafe').checked = true;
        }

        document.getElementById('deleteWarning').innerHTML = warningMessage;
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
    }

    // View Details Modal Functions
    let currentDormitoryOwnerId = null;

    function viewDormitoryOwnerDetails(id, name) {
        currentDormitoryOwnerId = id;
        document.getElementById('viewDetailsTitle').textContent = `${name} - Details`;

        // Fetch dormitory owner details via AJAX
        fetch(`/dashboard/admin/dormitory-owners/details/${id}/`)
            .then(response => response.json())
            .then(data => {
                // Populate owner details
                document.getElementById('ownerName').textContent = data.owner.full_name;
                document.getElementById('ownerRole').textContent = data.owner.role;
                document.getElementById('ownerEmail').textContent = data.owner.email;
                document.getElementById('ownerOffice').textContent = data.owner.office;
                document.getElementById('ownerStudentCount').textContent = `${data.owner.student_count} students`;
                document.getElementById('ownerProfilePic').src = data.owner.profile_picture || '/static/images/default-profile.png';

                // Populate student list
                const studentsList = document.getElementById('assignedStudentsList');
                studentsList.innerHTML = '';

                if (data.students && data.students.length > 0) {
                    document.getElementById('noStudentsMessage').classList.add('hidden');

                    data.students.forEach(student => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${student.student_id}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${student.name}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${student.course}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${student.year_level}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                <button onclick="unassignStudent(${student.id})" class="text-red-600 hover:text-red-900">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </td>
                        `;
                        studentsList.appendChild(row);
                    });
                } else {
                    document.getElementById('noStudentsMessage').classList.remove('hidden');
                }

                // Show the modal
                document.getElementById('viewDetailsModal').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error fetching dormitory owner details:', error);
                alert('Failed to load dormitory owner details. Please try again.');
            });
    }

    function closeViewDetailsModal() {
        document.getElementById('viewDetailsModal').classList.add('hidden');
        currentDormitoryOwnerId = null;
    }

    function editFromDetails() {
        if (currentDormitoryOwnerId) {
            const name = document.getElementById('ownerName').textContent;
            const role = document.getElementById('ownerRole').textContent;
            closeViewDetailsModal();
            editDormitoryOwner(currentDormitoryOwnerId, name, role);
        }
    }

    function deleteFromDetails() {
        if (currentDormitoryOwnerId) {
            const name = document.getElementById('ownerName').textContent;
            const studentCount = parseInt(document.getElementById('ownerStudentCount').textContent);
            closeViewDetailsModal();
            confirmDelete(currentDormitoryOwnerId, name, studentCount);
        }
    }

    // Batch Functions
    function openBatchAssignModal() {
        // Fetch unassigned students before opening the modal
        fetch('/dashboard/admin/dormitory-owners/unassigned-students/')
            .then(response => response.json())
            .then(data => {
                const studentsList = document.querySelector('#batchAssignForm .student-list');
                studentsList.innerHTML = '';

                if (data.students && data.students.length > 0) {
                    data.students.forEach(student => {
                        const studentItem = document.createElement('div');
                        studentItem.className = 'flex items-center';
                        studentItem.innerHTML = `
                            <input type="checkbox" id="student_${student.id}" name="student_ids" value="${student.id}"
                                   class="student-checkbox h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                            <label for="student_${student.id}" class="ml-2 text-sm text-gray-700">
                                ${student.name} (${student.student_id}) - ${student.course}
                            </label>
                        `;
                        studentsList.appendChild(studentItem);
                    });

                    // Show the student list and hide the no students message
                    document.getElementById('noUnassignedStudentsMessage').classList.add('hidden');
                    document.querySelector('#batchAssignForm .student-list-container').classList.remove('hidden');
                } else {
                    // Show the no students message and hide the student list
                    document.getElementById('noUnassignedStudentsMessage').classList.remove('hidden');
                    document.querySelector('#batchAssignForm .student-list-container').classList.add('hidden');
                }

                // Open the modal
                document.getElementById('batchAssignModal').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error fetching unassigned students:', error);
                alert('Failed to load unassigned students. Please try again.');
            });
    }

    function closeBatchAssignModal() {
        document.getElementById('batchAssignModal').classList.add('hidden');
        document.getElementById('batchAssignForm').reset();
    }

    function openBatchExportModal() {
        document.getElementById('batchExportModal').classList.remove('hidden');
    }

    function closeBatchExportModal() {
        document.getElementById('batchExportModal').classList.add('hidden');
        document.getElementById('batchExportForm').reset();
    }

    // Student Management Functions
    function unassignStudent(studentId) {
        if (confirm('Are you sure you want to unassign this student?')) {
            fetch('/dashboard/admin/dormitory-owners/unassign-student/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    student_id: studentId,
                    dormitory_owner_id: currentDormitoryOwnerId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh the details view
                    viewDormitoryOwnerDetails(currentDormitoryOwnerId, document.getElementById('ownerName').textContent);
                } else {
                    alert(data.message || 'Failed to unassign student.');
                }
            })
            .catch(error => {
                console.error('Error unassigning student:', error);
                alert('An error occurred while unassigning the student.');
            });
        }
    }

    function openAssignStudentsModal() {
        if (!currentDormitoryOwnerId) {
            alert('No dormitory owner selected.');
            return;
        }

        // Fetch unassigned students
        fetch('/dashboard/admin/dormitory-owners/unassigned-students/')
            .then(response => response.json())
            .then(data => {
                // Create and show a modal for assigning students
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
                modal.id = 'assignStudentsModal';

                let studentListHtml = '';
                if (data.students && data.students.length > 0) {
                    data.students.forEach(student => {
                        studentListHtml += `
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="assign_student_${student.id}" name="student_ids" value="${student.id}"
                                       class="assign-student-checkbox h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="assign_student_${student.id}" class="ml-2 text-sm text-gray-700">
                                    ${student.name} (${student.student_id}) - ${student.course}
                                </label>
                            </div>
                        `;
                    });
                } else {
                    studentListHtml = '<p class="text-sm text-gray-500 text-center">No unassigned students found.</p>';
                }

                const ownerName = document.getElementById('ownerName').textContent;

                modal.innerHTML = `
                    <div class="relative top-20 mx-auto p-5 border w-[500px] shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium text-gray-900">Assign Students to ${ownerName}</h3>
                                <button onclick="closeAssignStudentsModal()" class="text-gray-400 hover:text-gray-500">
                                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>

                            <form id="assignStudentsForm" method="POST" action="{% url 'assign_students' %}" class="mt-4">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                <input type="hidden" name="dormitory_owner_id" value="${currentDormitoryOwnerId}">

                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Students to Assign</label>
                                    <div class="border border-gray-300 rounded-md p-3 max-h-60 overflow-y-auto">
                                        <div class="mb-2">
                                            <input type="checkbox" id="assign_select_all" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                            <label for="assign_select_all" class="ml-2 text-sm font-medium text-gray-700">Select All</label>
                                        </div>
                                        <div class="space-y-2 mt-3">
                                            ${studentListHtml}
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="assign_mark_as_boarders" name="mark_as_boarders" checked
                                               class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                        <label for="assign_mark_as_boarders" class="ml-2 text-sm text-gray-700">Mark selected students as boarders</label>
                                    </div>
                                </div>

                                <div class="mt-5 flex justify-end gap-2">
                                    <button type="button" onclick="closeAssignStudentsModal()"
                                            class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                        Assign Students
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Add event listener for select all checkbox
                document.getElementById('assign_select_all').addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.assign-student-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });

                // Add event listener for form submission
                document.getElementById('assignStudentsForm').addEventListener('submit', function(e) {
                    const selectedStudents = document.querySelectorAll('.assign-student-checkbox:checked');
                    if (selectedStudents.length === 0) {
                        e.preventDefault();
                        alert('Please select at least one student to assign.');
                        return false;
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching unassigned students:', error);
                alert('Failed to load unassigned students. Please try again.');
            });
    }

    function closeAssignStudentsModal() {
        const modal = document.getElementById('assignStudentsModal');
        if (modal) {
            modal.remove();
        }
    }

    function sendNotificationToStudents() {
        // This would open a modal to send notifications to students
        alert('This feature will be implemented soon!');
    }

    function printStudentList() {
        // This would print the student list for the current dormitory owner
        alert('This feature will be implemented soon!');
    }

    function printDormitoryOwnersList() {
        // This would print the dormitory owners list
        alert('This feature will be implemented soon!');
    }
</script>
{% endblock %}

{% block admin_content %}
<div class="p-6 space-y-8">
    <!-- Header Section -->
    <div class="mb-8 bg-gradient-to-r from-emerald-500 to-emerald-700 p-6 rounded-xl shadow-lg text-white">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Dormitory Owner Management</h1>
                <p class="mt-2 text-emerald-100">Manage dormitory owners and their assigned students</p>
            </div>
            <button onclick="openAddModal()"
                    class="px-4 py-2 bg-white text-emerald-700 rounded-lg hover:bg-emerald-50 transition-colors duration-200 font-medium shadow-sm">
                <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add Dormitory Owner
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    {% include 'components/dormitory_owners/stats_cards.html' %}

    <!-- Search and Filter Section -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Search & Filter</h2>
        <form id="searchForm" class="grid grid-cols-1 md:grid-cols-3 gap-4" method="GET">
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" id="search" name="search" value="{{ request.GET.search }}"
                       placeholder="Name, email, or role"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
            </div>
            <div>
                <label for="student_count" class="block text-sm font-medium text-gray-700 mb-1">Student Count</label>
                <select id="student_count" name="student_count" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="">Any</option>
                    <option value="0" {% if request.GET.student_count == '0' %}selected{% endif %}>No students</option>
                    <option value="1-5" {% if request.GET.student_count == '1-5' %}selected{% endif %}>1-5 students</option>
                    <option value="6-10" {% if request.GET.student_count == '6-10' %}selected{% endif %}>6-10 students</option>
                    <option value="10+" {% if request.GET.student_count == '10+' %}selected{% endif %}>More than 10 students</option>
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 mr-2">
                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Search
                </button>
                <a href="{% url 'admin_dormitory_owners' %}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Batch Actions -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Batch Actions</h2>
        <div class="flex flex-wrap gap-3">
            <button onclick="openBatchAssignModal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Batch Assign Students
            </button>
            <button onclick="openBatchExportModal()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Export Data
            </button>
            <button onclick="printDormitoryOwnersList()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                </svg>
                Print List
            </button>
        </div>
    </div>

    <!-- Dormitory Owners List -->
    {% include 'components/dormitory_owners/owners_list.html' %}

    <!-- Add Dormitory Owner Modal -->
    <div id="addModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Add New Dormitory Owner</h3>
                <form id="addForm" method="POST" action="{% url 'admin_dormitory_owners' %}" class="mt-2">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add">

                    <div class="mb-4">
                        <label for="user" class="block text-sm font-medium text-gray-700">Select User</label>
                        <select id="user" name="user" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" required>
                            <option value="">Select a user</option>
                            {% for user in available_users %}
                            <option value="{{ user.id }}">{{ user.get_full_name }} ({{ user.username }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="role" class="block text-sm font-medium text-gray-700">Role</label>
                        <input type="text" id="role" name="role" value="Dormitory Owner" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" required>
                    </div>

                    <div class="mt-5 flex justify-end gap-2">
                        <button type="button" onclick="closeAddModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            Add Dormitory Owner
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Dormitory Owner Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Edit Dormitory Owner</h3>
                <form id="editForm" method="POST" action="{% url 'admin_dormitory_owners' %}" class="mt-2">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="staff_id" id="editStaffId">

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <div id="editName" class="mt-1 block w-full py-2 text-base text-gray-700"></div>
                    </div>

                    <div class="mb-4">
                        <label for="editRole" class="block text-sm font-medium text-gray-700">Role</label>
                        <input type="text" id="editRole" name="role" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" required>
                    </div>

                    <div class="mt-5 flex justify-end gap-2">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            Update
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Dormitory Owner Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Delete Dormitory Owner</h3>
                <div id="deleteWarning" class="mt-2 text-sm text-gray-500"></div>

                <form id="deleteForm" method="POST" action="{% url 'admin_dormitory_owners' %}" class="mt-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="staff_id" id="deleteStaffId">

                    <div id="deleteOptions" class="mb-4">
                        <div class="flex items-center mb-2">
                            <input type="radio" id="deleteSafe" name="delete_type" value="safe" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                            <label for="deleteSafe" class="ml-2 block text-sm text-gray-700">Safe Delete (Only if no students assigned)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="deleteForce" name="delete_type" value="force" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                            <label for="deleteForce" class="ml-2 block text-sm text-gray-700">Force Delete (Unassign all students)</label>
                        </div>
                    </div>

                    <div class="mt-5 flex justify-end gap-2">
                        <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                            Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Batch Assign Students Modal -->
    <div id="batchAssignModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Batch Assign Students</h3>
                <p class="text-sm text-gray-500 mt-1">Assign multiple students to a dormitory owner at once.</p>

                <form id="batchAssignForm" method="POST" action="{% url 'admin_dormitory_owners' %}" class="mt-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="batch_assign">

                    <div class="mb-4">
                        <label for="batch_dormitory_owner" class="block text-sm font-medium text-gray-700">Select Dormitory Owner</label>
                        <select id="batch_dormitory_owner" name="dormitory_owner_id" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" required>
                            <option value="">Select a dormitory owner</option>
                            {% for owner in dormitory_owners %}
                            <option value="{{ owner.id }}">{{ owner.get_full_name }} ({{ owner.student_count }} students)</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Students</label>
                        <div id="noUnassignedStudentsMessage" class="hidden p-4 text-center text-gray-500 border border-gray-300 rounded-md">
                            No unassigned students found. All students are already assigned to dormitory owners.
                        </div>
                        <div class="student-list-container border border-gray-300 rounded-md p-3 max-h-60 overflow-y-auto">
                            <div class="mb-2">
                                <input type="checkbox" id="select_all_students" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="select_all_students" class="ml-2 text-sm font-medium text-gray-700">Select All</label>
                            </div>
                            <div class="space-y-2 mt-3 student-list">
                                <!-- Student list will be populated dynamically -->
                                <div class="flex justify-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div>
                                    <span class="ml-2 text-sm text-gray-500">Loading students...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="mark_as_boarders" name="mark_as_boarders" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                            <label for="mark_as_boarders" class="ml-2 text-sm text-gray-700">Mark selected students as boarders</label>
                        </div>
                    </div>

                    <div class="mt-5 flex justify-end gap-2">
                        <button type="button" onclick="closeBatchAssignModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Assign Students
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Batch Export Modal -->
    <div id="batchExportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Export Dormitory Owner Data</h3>
                <p class="text-sm text-gray-500 mt-1">Select the format and data to export.</p>

                <form id="batchExportForm" method="POST" action="{% url 'admin_dormitory_owners' %}" class="mt-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="export_data">

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input type="radio" id="export_pdf" name="export_format" value="pdf" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="export_pdf" class="ml-2 text-sm text-gray-700">PDF</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="export_excel" name="export_format" value="excel" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="export_excel" class="ml-2 text-sm text-gray-700">Excel</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="export_csv" name="export_format" value="csv" class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="export_csv" class="ml-2 text-sm text-gray-700">CSV</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Include Data</label>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="include_owners" name="include_owners" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="include_owners" class="ml-2 text-sm text-gray-700">Dormitory Owners</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="include_students" name="include_students" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="include_students" class="ml-2 text-sm text-gray-700">Assigned Students</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="include_contact" name="include_contact" checked class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                <label for="include_contact" class="ml-2 text-sm text-gray-700">Contact Information</label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 flex justify-end gap-2">
                        <button type="button" onclick="closeBatchExportModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            Export
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Dormitory Owner Details Modal -->
    <div id="viewDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-[800px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-medium text-gray-900" id="viewDetailsTitle">Dormitory Owner Details</h3>
                    <button onclick="closeViewDetailsModal()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Owner Information -->
                    <div class="col-span-1 bg-gray-50 p-4 rounded-lg">
                        <div class="flex flex-col items-center">
                            <div class="h-24 w-24 rounded-full overflow-hidden mb-3">
                                <img id="ownerProfilePic" src="" alt="Profile Picture" class="h-full w-full object-cover">
                            </div>
                            <h4 id="ownerName" class="text-lg font-medium text-gray-900">Owner Name</h4>
                            <p id="ownerRole" class="text-sm text-gray-500">Role</p>
                        </div>
                        <div class="mt-4 space-y-2">
                            <div class="flex items-center">
                                <svg class="h-5 w-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                <span id="ownerEmail" class="text-sm text-gray-600">email@example.com</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="h-5 w-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span id="ownerOffice" class="text-sm text-gray-600">Office</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="h-5 w-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                                <span id="ownerStudentCount" class="text-sm text-gray-600">0 students</span>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-center space-x-2">
                            <button onclick="editFromDetails()" class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                Edit
                            </button>
                            <button onclick="deleteFromDetails()" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                                Delete
                            </button>
                        </div>
                    </div>

                    <!-- Assigned Students -->
                    <div class="col-span-2">
                        <h4 class="text-lg font-medium text-gray-900 mb-3">Assigned Students</h4>
                        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                            <div class="max-h-96 overflow-y-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Course</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Year</th>
                                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assignedStudentsList" class="bg-white divide-y divide-gray-200">
                                        <!-- Student rows will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noStudentsMessage" class="hidden p-4 text-center text-gray-500">
                                No students assigned to this dormitory owner.
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="mt-4">
                            <h5 class="text-md font-medium text-gray-900 mb-2">Quick Actions</h5>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="openAssignStudentsModal()" class="px-3 py-1.5 bg-emerald-600 text-white text-sm rounded hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Assign Students
                                </button>
                                <button onclick="sendNotificationToStudents()" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                    </svg>
                                    Send Notification
                                </button>
                                <button onclick="printStudentList()" class="px-3 py-1.5 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                    </svg>
                                    Print List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Make sure forms are properly submitted
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, setting up form handlers');

        // Add form submit handler
        const addForm = document.getElementById('addForm');
        if (addForm) {
            addForm.addEventListener('submit', function(e) {
                console.log('Add form submitted');
            });
        }

        // Edit form submit handler
        const editForm = document.getElementById('editForm');
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                console.log('Edit form submitted');
            });
        }

        // Delete form submit handler
        const deleteForm = document.getElementById('deleteForm');
        if (deleteForm) {
            deleteForm.addEventListener('submit', function(e) {
                console.log('Delete form submitted');
            });
        }

        // Batch assign form submit handler
        const batchAssignForm = document.getElementById('batchAssignForm');
        if (batchAssignForm) {
            batchAssignForm.addEventListener('submit', function(e) {
                const selectedStudents = document.querySelectorAll('#batchAssignForm input[name="student_ids"]:checked');
                if (selectedStudents.length === 0) {
                    e.preventDefault();
                    alert('Please select at least one student to assign.');
                    return false;
                }

                const dormitoryOwner = document.getElementById('batch_dormitory_owner').value;
                if (!dormitoryOwner) {
                    e.preventDefault();
                    alert('Please select a dormitory owner.');
                    return false;
                }

                console.log('Batch assign form submitted');
            });
        }

        // Select all students checkbox
        const selectAllCheckbox = document.getElementById('select_all_students');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const studentCheckboxes = document.querySelectorAll('.student-checkbox');
                studentCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
            });
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addModal');
            const editModal = document.getElementById('editModal');
            const deleteModal = document.getElementById('deleteModal');
            const batchAssignModal = document.getElementById('batchAssignModal');
            const batchExportModal = document.getElementById('batchExportModal');
            const viewDetailsModal = document.getElementById('viewDetailsModal');

            if (event.target === addModal) {
                closeAddModal();
            } else if (event.target === editModal) {
                closeEditModal();
            } else if (event.target === deleteModal) {
                closeDeleteModal();
            } else if (event.target === batchAssignModal) {
                closeBatchAssignModal();
            } else if (event.target === batchExportModal) {
                closeBatchExportModal();
            } else if (event.target === viewDetailsModal) {
                closeViewDetailsModal();
            }
        };
    });
</script>
{% endblock %}