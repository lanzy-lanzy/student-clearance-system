{% load myfilters %}
<!-- Reports & Statistics View -->
<div class="space-y-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <h2 class="text-lg font-bold text-gray-900">Reports & Statistics</h2>
        </div>

        <!-- Filter Controls -->
        <div class="flex flex-wrap items-center gap-3">
            <div class="w-full sm:w-auto">
                <label for="report_school_year" class="block text-sm font-medium text-gray-700 mb-1">School Year</label>
                <select id="report_school_year" name="school_year" onchange="updateReports()"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                    {% for year in available_years %}
                        <option value="{{ year }}" {% if selected_school_year == year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="w-full sm:w-auto">
                <label for="report_semester" class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                <select id="report_semester" name="semester" onchange="updateReports()"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                    <option value="1ST_MID" {% if selected_semester == '1ST_MID' %}selected{% endif %}>1st Sem - Midterm</option>
                    <option value="1ST_FIN" {% if selected_semester == '1ST_FIN' %}selected{% endif %}>1st Sem - Final</option>
                    <option value="2ND_MID" {% if selected_semester == '2ND_MID' %}selected{% endif %}>2nd Sem - Midterm</option>
                    <option value="2ND_FIN" {% if selected_semester == '2ND_FIN' %}selected{% endif %}>2nd Sem - Final</option>
                    <option value="SUM" {% if selected_semester == 'SUM' %}selected{% endif %}>Summer</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Total Students -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-5 bg-gradient-to-r from-blue-500 to-blue-600">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-white">Total Students</h3>
                    <span class="text-2xl font-bold text-white">{{ total_students }}</span>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">Under your supervision</span>
                </div>
            </div>
        </div>

        <!-- Cleared Students -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-5 bg-gradient-to-r from-green-500 to-green-600">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-white">Cleared</h3>
                    <span class="text-2xl font-bold text-white">{{ cleared_count }}</span>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">{{ cleared_percentage }}% of total</span>
                </div>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-green-600 h-2.5 rounded-full" style="width: {{ cleared_percentage }}%"></div>
                </div>
            </div>
        </div>

        <!-- Pending Students -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-5 bg-gradient-to-r from-yellow-500 to-yellow-600">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-white">Pending</h3>
                    <span class="text-2xl font-bold text-white">{{ pending_count }}</span>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">{{ pending_percentage }}% of total</span>
                </div>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-yellow-600 h-2.5 rounded-full" style="width: {{ pending_percentage }}%"></div>
                </div>
            </div>
        </div>

        <!-- Permits Issued -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-5 bg-gradient-to-r from-purple-500 to-purple-600">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-white">Permits Issued</h3>
                    <span class="text-2xl font-bold text-white">{{ permits_issued }}</span>
                </div>
            </div>
            <div class="p-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">{{ permits_percentage }}% of cleared students</span>
                </div>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-purple-600 h-2.5 rounded-full" style="width: {{ permits_percentage }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
        <!-- Clearance Progress Chart -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Clearance Progress by Year Level</h3>
            </div>
            <div class="p-6">
                <canvas id="yearLevelChart" height="300"></canvas>
            </div>
        </div>

        <!-- Clearance Timeline Chart -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Clearance Timeline</h3>
            </div>
            <div class="p-6">
                <canvas id="timelineChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Reports Section -->
    <div class="bg-white rounded-lg shadow overflow-hidden mt-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">Detailed Reports</h3>
        </div>
        <div class="p-6">
            <div class="space-y-6">


                <!-- Search Bar -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="student-search" placeholder="Search by name, ID number, or year level..."
                               class="w-full px-4 py-2 pl-10 pr-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               onkeyup="if(event.key === 'Enter') searchStudents()">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <button onclick="searchStudents()" class="absolute inset-y-0 right-0 px-4 text-emerald-600 font-medium hover:text-emerald-800">
                            Search
                        </button>
                    </div>
                </div>

                <!-- Report Content -->
                <div id="reportContent" class="mt-6">
                    <!-- Report content will be loaded here -->
                    <div class="text-center py-8 text-gray-500">
                        Select a report type to view detailed statistics
                    </div>
                </div>

                <!-- Report Action Buttons -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <button onclick="showYearLevelList()" class="px-4 py-3 bg-emerald-600 text-white text-sm rounded-md hover:bg-emerald-700 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Year Level
                    </button>
                    <button onclick="showStudentsList()" class="px-4 py-3 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        Students List
                    </button>
                    <button onclick="showClearedStudents()" class="px-4 py-3 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Cleared Students
                    </button>
                    <button onclick="showPendingStudents()" class="px-4 py-3 bg-orange-600 text-white text-sm rounded-md hover:bg-orange-700 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Pending Students
                    </button>
                </div>

                <!-- Export Data Button -->
                <div class="flex justify-center mt-6">
                    <button onclick="displayStudentNamelist()" class="px-6 py-3 bg-purple-600 text-white text-base rounded-md hover:bg-purple-700 transition-colors flex items-center justify-center shadow-md">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span class="whitespace-nowrap font-medium">Export Data</span>
                    </button>
                </div>

                <!-- Student Namelist Container -->
                <div id="studentNamelistContainer" class="mt-6 hidden">
                    <!-- Header with PDF button -->
                    <div class="bg-purple-600 text-white px-4 py-3 rounded-t-lg flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Student's List - <span id="namelistTitle"></span></h3>
                        <button onclick="exportStudentsByYearLevel()" class="px-3 py-1 bg-white text-purple-700 text-sm rounded hover:bg-gray-100 transition-colors flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            PDF
                        </button>
                    </div>

                    <div class="bg-white rounded-b-lg shadow-md overflow-hidden">
                        <div class="p-4">
                            <div class="text-sm text-gray-500 mb-4">
                                Generated on: <span id="generatedDate"></span>
                            </div>
                            <div id="yearLevelSummary" class="mb-6">
                                <!-- Year level summary table will be inserted here -->
                            </div>
                            <div id="studentNamelist" class="mt-6">
                                <!-- Student namelist will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Instructions -->
                <div class="mt-4 p-3 sm:p-4 bg-blue-50 text-blue-800 rounded-md">
                    <div class="flex items-start">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="text-xs sm:text-sm font-medium">Instructions:</p>
                            <ol class="text-xs mt-1 list-decimal list-inside">
                                <li>Use the buttons above to view different reports:</li>
                                <ul class="ml-5 list-disc text-xs">
                                    <li><strong>Year Level</strong> - View statistics by year level</li>
                                    <li><strong>Students List</strong> - View complete list of students</li>
                                    <li><strong>Cleared Students</strong> - View only cleared students</li>
                                    <li><strong>Pending Students</strong> - View students with pending clearance</li>
                                </ul>
                                <li>Use the search bar to find specific students by name, ID, or year level</li>
                                <li>Each report includes an export option to download the data</li>
                                <li>Click the "Export Data" button to generate a comprehensive report with all details</li>
                                <li>The PDF button allows you to download a printable version of any report</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JavaScript for Charts and Reports -->
<script>
    // Sample data for charts - in a real implementation, this would come from the server
    const yearLevelData = {
        labels: ['1st Year', '2nd Year', '3rd Year', '4th Year', '5th Year'],
        datasets: [
            {
                label: 'Cleared',
                data: [65, 75, 80, 85, 90],
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
            },
            {
                label: 'Pending',
                data: [25, 20, 15, 10, 5],
                backgroundColor: 'rgba(245, 158, 11, 0.7)',
            },
            {
                label: 'Not Started',
                data: [10, 5, 5, 5, 5],
                backgroundColor: 'rgba(156, 163, 175, 0.7)',
            }
        ]
    };

    const timelineData = {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
        datasets: [{
            label: 'Clearances Completed',
            data: [12, 25, 45, 65, 80, 95],
            borderColor: 'rgba(16, 185, 129, 1)',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
        }]
    };

    // Initialize charts when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
    });

    function initializeCharts() {
        // Year Level Chart
        const yearLevelCtx = document.getElementById('yearLevelChart').getContext('2d');
        const yearLevelChart = new Chart(yearLevelCtx, {
            type: 'bar',
            data: yearLevelData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        // Timeline Chart
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        const timelineChart = new Chart(timelineCtx, {
            type: 'line',
            data: timelineData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    function updateReports() {
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;

        // Redirect to the same page with updated parameters
        window.location.href = `{% url 'program_chair_dashboard' %}?view=reports&school_year=${schoolYear}&semester=${semester}`;
    }

    function showYearLevelList() {
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const reportContent = document.getElementById('reportContent');

        // Show loading state
        reportContent.innerHTML = `
            <div class="text-center py-8">
                <svg class="animate-spin h-8 w-8 text-emerald-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Loading year level data...</p>
            </div>
        `;

        // Fetch report data from the server
        fetch(`/api/program-chair/reports/year_level/?school_year=${schoolYear}&semester=${semester}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    renderYearLevelReport(data.data);
                } else {
                    reportContent.innerHTML = `<div class="text-center py-8 text-red-500">${data.error || 'Error loading report data'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching report data:', error);
                reportContent.innerHTML = `<div class="text-center py-8 text-red-500">Error loading report data: ${error.message}</div>`;
            });
    }

    function renderYearLevelReport(data) {
        const reportContent = document.getElementById('reportContent');

        let tableRows = '';
        data.forEach(item => {
            const clearanceRate = ((item.cleared / item.total) * 100).toFixed(1);
            tableRows += `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${item.year_level}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.total}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.cleared}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.pending}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.not_started}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-16 sm:w-24 bg-gray-200 rounded-full h-2 sm:h-2.5 mr-2">
                                <div class="bg-emerald-600 h-2 sm:h-2.5 rounded-full" style="width: ${clearanceRate}%"></div>
                            </div>
                            <span class="text-xs sm:text-sm text-gray-700">${clearanceRate}%</span>
                        </div>
                    </td>
                </tr>
            `;
        });

        reportContent.innerHTML = `
            <h4 class="text-lg font-medium text-gray-800 mb-4">Clearance Status by Year Level</h4>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden shadow-sm border border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Level</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cleared</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Not Started</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clearance Rate</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function renderCourseReport(data) {
        const reportContent = document.getElementById('reportContent');

        let tableRows = '';
        data.forEach(item => {
            const clearanceRate = ((item.cleared / item.total) * 100).toFixed(1);
            tableRows += `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${item.course_code}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.course_name}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.total}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.cleared}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.pending}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-16 sm:w-24 bg-gray-200 rounded-full h-2 sm:h-2.5 mr-2">
                                <div class="bg-emerald-600 h-2 sm:h-2.5 rounded-full" style="width: ${clearanceRate}%"></div>
                            </div>
                            <span class="text-xs sm:text-sm text-gray-700">${clearanceRate}%</span>
                        </div>
                    </td>
                </tr>
            `;
        });

        reportContent.innerHTML = `
            <h4 class="text-lg font-medium text-gray-800 mb-4">Clearance Status by Course</h4>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden shadow-sm border border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cleared</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function renderOfficeReport(data) {
        const reportContent = document.getElementById('reportContent');

        let tableRows = '';
        data.forEach(item => {
            const approvalRate = ((item.approved / item.total) * 100).toFixed(1);
            tableRows += `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${item.office_name}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.total}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.approved}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.pending}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.average_days.toFixed(1)} d</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-16 sm:w-24 bg-gray-200 rounded-full h-2 sm:h-2.5 mr-2">
                                <div class="bg-emerald-600 h-2 sm:h-2.5 rounded-full" style="width: ${approvalRate}%"></div>
                            </div>
                            <span class="text-xs sm:text-sm text-gray-700">${approvalRate}%</span>
                        </div>
                    </td>
                </tr>
            `;
        });

        reportContent.innerHTML = `
            <h4 class="text-lg font-medium text-gray-800 mb-4">Clearance Status by Office</h4>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden shadow-sm border border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Office</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requests</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approved</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Time</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function renderTimelineReport(data) {
        const reportContent = document.getElementById('reportContent');

        let tableRows = '';
        data.forEach(item => {
            tableRows += `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${item.date}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.new_clearances}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.completed_clearances}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.permits_issued}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${item.completion_rate}%</td>
                </tr>
            `;
        });

        reportContent.innerHTML = `
            <h4 class="text-lg font-medium text-gray-800 mb-4">Clearance Timeline</h4>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden shadow-sm border border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permits</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function applyReportFilters() {
        // Get the currently active report type
        let reportType = 'year_level'; // Default

        // Find which report is currently displayed
        const reportContent = document.getElementById('reportContent');
        if (reportContent.querySelector('h4')) {
            const reportTitle = reportContent.querySelector('h4').textContent.trim().toLowerCase();
            if (reportTitle.includes('year level')) reportType = 'year_level';
            else if (reportTitle.includes('course')) reportType = 'course';
            else if (reportTitle.includes('office')) reportType = 'office';
            else if (reportTitle.includes('timeline')) reportType = 'timeline';
        }

        // Get filter values
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const yearLevel = document.getElementById('report_year_level').value;
        const studentStatus = document.getElementById('report_student_status').value;

        // Show loading state
        reportContent.innerHTML = `
            <div class="text-center py-8">
                <svg class="animate-spin h-8 w-8 text-emerald-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Loading report data with filters...</p>
            </div>
        `;

        // Fetch report data with filters
        let url = `/api/program-chair/reports/${reportType}/?school_year=${schoolYear}&semester=${semester}`;
        if (yearLevel) url += `&year_level=${yearLevel}`;
        if (studentStatus) url += `&student_status=${studentStatus}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Render the appropriate report based on type
                    switch (reportType) {
                        case 'year_level':
                            renderYearLevelReport(data.data);
                            break;
                        case 'course':
                            renderCourseReport(data.data);
                            break;
                        case 'office':
                            renderOfficeReport(data.data);
                            break;
                        case 'timeline':
                            renderTimelineReport(data.data);
                            break;
                        default:
                            reportContent.innerHTML = '<div class="text-center py-8 text-gray-500">Invalid report type selected</div>';
                    }
                } else {
                    reportContent.innerHTML = `<div class="text-center py-8 text-red-500">${data.error || 'Error loading report data'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching report data:', error);
                reportContent.innerHTML = `<div class="text-center py-8 text-red-500">Error loading report data: ${error.message}</div>`;
            });
    }

    function exportReport(format) {
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;

        // Get the currently active report type
        let reportType = 'year_level'; // Default

        // Find which report is currently displayed
        const reportContent = document.getElementById('reportContent');
        if (reportContent.querySelector('h4')) {
            const reportTitle = reportContent.querySelector('h4').textContent.trim().toLowerCase();
            if (reportTitle.includes('year level')) reportType = 'year_level';
            else if (reportTitle.includes('course')) reportType = 'course';
            else if (reportTitle.includes('office')) reportType = 'office';
            else if (reportTitle.includes('timeline')) reportType = 'timeline';
        } else {
            // If no report is displayed, show a message
            alert('Please select a report type first before exporting.');
            return;
        }

        // Get filter values
        const yearLevel = document.getElementById('report_year_level').value;
        const studentStatus = document.getElementById('report_student_status').value;

        // Show loading indicator
        const exportBtn = document.querySelector(`button[onclick="exportReport('${format}')"]`);
        const originalText = exportBtn.textContent;
        exportBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Exporting...
        `;
        exportBtn.disabled = true;

        // Build the URL with filters
        let url = `/api/program-chair/export/${format}/?school_year=${schoolYear}&semester=${semester}&report_type=${reportType}`;
        if (yearLevel) url += `&year_level=${yearLevel}`;
        if (studentStatus) url += `&student_status=${studentStatus}`;

        // Redirect to export endpoint
        window.location.href = url;

        // Reset button after a delay (since we're navigating away)
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }, 3000);
    }

    function exportClearedStudents() {
        // Get filter values
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const yearLevel = document.getElementById('report_year_level').value;

        // Always use "cleared" as the student status for this specific export
        // This ensures we're always getting cleared students regardless of the filter

        // Show export format modal
        Swal.fire({
            title: 'Export Cleared Students',
            html: `
                <div class="mb-4">
                    <p class="mb-2 text-left">Select export format:</p>
                    <div class="flex justify-center space-x-4">
                        <button id="pdf-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">PDF</button>
                        <button id="excel-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Excel</button>
                    </div>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Cancel',
            cancelButtonColor: '#6B7280',
            didOpen: () => {
                document.getElementById('pdf-btn').addEventListener('click', () => {
                    let url = `/api/program-chair/export/pdf/?school_year=${schoolYear}&semester=${semester}&report_type=cleared_students&student_status=cleared`;

                    if (yearLevel) {
                        url += `&year_level=${yearLevel}`;
                    }

                    window.open(url, '_blank');
                    Swal.close();
                });

                document.getElementById('excel-btn').addEventListener('click', () => {
                    let url = `/api/program-chair/export/excel/?school_year=${schoolYear}&semester=${semester}&report_type=cleared_students&student_status=cleared`;

                    if (yearLevel) {
                        url += `&year_level=${yearLevel}`;
                    }

                    window.open(url, '_blank');
                    Swal.close();
                });
            }
        });
    }

    function showStudentsList() {
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const reportContent = document.getElementById('reportContent');

        // Update active button
        const allButtons = document.querySelectorAll('#btn-year-level, #btn-students-list, #btn-cleared-students, #btn-pending-students');
        allButtons.forEach(btn => {
            if (btn.id === 'btn-year-level') {
                btn.classList.remove('bg-emerald-700');
                btn.classList.add('bg-emerald-600');
            } else if (btn.id === 'btn-students-list') {
                btn.classList.remove('bg-blue-700');
                btn.classList.add('bg-blue-600');
            } else if (btn.id === 'btn-cleared-students') {
                btn.classList.remove('bg-green-700');
                btn.classList.add('bg-green-600');
            } else if (btn.id === 'btn-pending-students') {
                btn.classList.remove('bg-orange-700');
                btn.classList.add('bg-orange-600');
            }
        });

        // Highlight the active button
        const activeButton = document.getElementById('btn-students-list');
        activeButton.classList.remove('bg-blue-600');
        activeButton.classList.add('bg-blue-700');

        // Show loading state
        reportContent.innerHTML = `
            <div class="text-center py-8">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Loading students list...</p>
            </div>
        `;

        // Fetch students data for this program chair's department
        fetch(`/api/program-chair/students/?school_year=${schoolYear}&semester=${semester}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    renderStudentsList(data.data);
                } else {
                    reportContent.innerHTML = `<div class="text-center py-8 text-red-500">${data.error || 'Error loading students data'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching students data:', error);
                reportContent.innerHTML = `<div class="text-center py-8 text-red-500">Error loading students data: ${error.message}</div>`;
            });
    }

    function renderStudentsList(students) {
        const reportContent = document.getElementById('reportContent');

        if (!students || students.length === 0) {
            reportContent.innerHTML = `<div class="text-center py-8 text-gray-500">No students found for the selected filters</div>`;
            return;
        }

        // Group students by year level
        const studentsByYear = {};
        students.forEach(student => {
            const yearLevel = student.year_level || 'Unknown';
            if (!studentsByYear[yearLevel]) {
                studentsByYear[yearLevel] = [];
            }
            studentsByYear[yearLevel].push(student);
        });

        // Create the HTML for the students list
        let html = `
            <h4 class="text-lg font-medium text-gray-800 mb-4">Complete Students List</h4>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden shadow-sm border border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Level</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
        `;

        // Sort students alphabetically by last name
        const allStudents = students.sort((a, b) => {
            const nameA = `${a.last_name}, ${a.first_name}`.toLowerCase();
            const nameB = `${b.last_name}, ${b.first_name}`.toLowerCase();
            return nameA.localeCompare(nameB);
        });

        // Add all students to the table
        allStudents.forEach(student => {
            const yearLevelText = {
                1: '1st Year',
                2: '2nd Year',
                3: '3rd Year',
                4: '4th Year',
                5: '5th Year'
            }[student.year_level] || `Year ${student.year_level}`;

            const statusClass = student.is_cleared ? 'text-green-600' : 'text-orange-600';
            const statusText = student.is_cleared ? 'Cleared' : 'Pending';

            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${student.student_id || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${student.last_name}, ${student.first_name}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${yearLevelText}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${student.course || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm ${statusClass} font-medium">${statusText}</td>
                </tr>
            `;
        });

        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button onclick="exportStudentsList()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    Export List
                </button>
            </div>
        `;

        reportContent.innerHTML = html;
    }

    function showClearedStudents() {
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const reportContent = document.getElementById('reportContent');

        // Show loading state
        reportContent.innerHTML = `
            <div class="text-center py-8">
                <svg class="animate-spin h-8 w-8 text-green-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Loading cleared students...</p>
            </div>
        `;

        // Fetch cleared students data for this program chair's department
        fetch(`/api/program-chair/students/?school_year=${schoolYear}&semester=${semester}&student_status=cleared`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    renderClearedStudentsList(data.data);
                } else {
                    reportContent.innerHTML = `<div class="text-center py-8 text-red-500">${data.error || 'Error loading cleared students data'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching cleared students data:', error);
                reportContent.innerHTML = `<div class="text-center py-8 text-red-500">Error loading cleared students data: ${error.message}</div>`;
            });
    }

    function renderClearedStudentsList(students) {
        const reportContent = document.getElementById('reportContent');

        if (!students || students.length === 0) {
            reportContent.innerHTML = `<div class="text-center py-8 text-gray-500">No cleared students found for the selected filters</div>`;
            return;
        }

        // Create the HTML for the cleared students list
        let html = `
            <h4 class="text-lg font-medium text-gray-800 mb-4">Cleared Students List</h4>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden shadow-sm border border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Level</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
        `;

        // Sort students alphabetically by last name
        const sortedStudents = students.sort((a, b) => {
            const nameA = `${a.last_name}, ${a.first_name}`.toLowerCase();
            const nameB = `${b.last_name}, ${b.first_name}`.toLowerCase();
            return nameA.localeCompare(nameB);
        });

        // Add all cleared students to the table
        sortedStudents.forEach(student => {
            const yearLevelText = {
                1: '1st Year',
                2: '2nd Year',
                3: '3rd Year',
                4: '4th Year',
                5: '5th Year'
            }[student.year_level] || `Year ${student.year_level}`;

            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${student.student_id || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${student.last_name}, ${student.first_name}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${yearLevelText}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${student.course || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-green-600 font-medium">Cleared</td>
                </tr>
            `;
        });

        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button onclick="exportClearedStudents()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    Export List
                </button>
            </div>
        `;

        reportContent.innerHTML = html;
    }

    function showPendingStudents() {
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const reportContent = document.getElementById('reportContent');

        // Show loading state
        reportContent.innerHTML = `
            <div class="text-center py-8">
                <svg class="animate-spin h-8 w-8 text-orange-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Loading pending students...</p>
            </div>
        `;

        // Fetch pending students data for this program chair's department
        fetch(`/api/program-chair/students/?school_year=${schoolYear}&semester=${semester}&student_status=pending`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    renderPendingStudentsList(data.data);
                } else {
                    reportContent.innerHTML = `<div class="text-center py-8 text-red-500">${data.error || 'Error loading pending students data'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching pending students data:', error);
                reportContent.innerHTML = `<div class="text-center py-8 text-red-500">Error loading pending students data: ${error.message}</div>`;
            });
    }

    function renderPendingStudentsList(students) {
        const reportContent = document.getElementById('reportContent');

        if (!students || students.length === 0) {
            reportContent.innerHTML = `<div class="text-center py-8 text-gray-500">No pending students found for the selected filters</div>`;
            return;
        }

        // Create the HTML for the pending students list
        let html = `
            <h4 class="text-lg font-medium text-gray-800 mb-4">Pending Students List</h4>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden shadow-sm border border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Level</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending Offices</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
        `;

        // Sort students alphabetically by last name
        const sortedStudents = students.sort((a, b) => {
            const nameA = `${a.last_name}, ${a.first_name}`.toLowerCase();
            const nameB = `${b.last_name}, ${b.first_name}`.toLowerCase();
            return nameA.localeCompare(nameB);
        });

        // Add all pending students to the table
        sortedStudents.forEach(student => {
            const yearLevelText = {
                1: '1st Year',
                2: '2nd Year',
                3: '3rd Year',
                4: '4th Year',
                5: '5th Year'
            }[student.year_level] || `Year ${student.year_level}`;

            const pendingOffices = student.pending_offices || [];
            const pendingOfficesText = pendingOffices.join(', ') || 'None';

            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${student.student_id || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${student.last_name}, ${student.first_name}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${yearLevelText}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${student.course || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm text-orange-600">${pendingOfficesText}</td>
                </tr>
            `;
        });

        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button onclick="exportPendingStudentsList()" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                    Export List
                </button>
            </div>
        `;

        reportContent.innerHTML = html;
    }

    function searchStudents() {
        const searchTerm = document.getElementById('student-search').value.trim().toLowerCase();
        if (!searchTerm) {
            alert('Please enter a search term');
            return;
        }

        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const reportContent = document.getElementById('reportContent');

        // Show loading state
        reportContent.innerHTML = `
            <div class="text-center py-8">
                <svg class="animate-spin h-8 w-8 text-emerald-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Searching for "${searchTerm}"...</p>
            </div>
        `;

        // Fetch all students data for this program chair's department
        fetch(`/api/program-chair/students/?school_year=${schoolYear}&semester=${semester}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const filteredStudents = data.data.filter(student => {
                        const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
                        const studentId = (student.student_id || '').toLowerCase();
                        const yearLevel = String(student.year_level || '').toLowerCase();

                        return fullName.includes(searchTerm) ||
                               studentId.includes(searchTerm) ||
                               yearLevel === searchTerm;
                    });

                    renderSearchResults(filteredStudents, searchTerm);
                } else {
                    reportContent.innerHTML = `<div class="text-center py-8 text-red-500">${data.error || 'Error searching for students'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error searching for students:', error);
                reportContent.innerHTML = `<div class="text-center py-8 text-red-500">Error searching for students: ${error.message}</div>`;
            });
    }

    function renderSearchResults(students, searchTerm) {
        const reportContent = document.getElementById('reportContent');

        if (!students || students.length === 0) {
            reportContent.innerHTML = `<div class="text-center py-8 text-gray-500">No students found matching "${searchTerm}"</div>`;
            return;
        }

        // Create the HTML for the search results
        let html = `
            <h4 class="text-lg font-medium text-gray-800 mb-4">Search Results for "${searchTerm}" (${students.length} found)</h4>
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <div class="overflow-hidden shadow-sm border border-gray-200 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Level</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                    <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
        `;

        // Sort students alphabetically by last name
        const sortedStudents = students.sort((a, b) => {
            const nameA = `${a.last_name}, ${a.first_name}`.toLowerCase();
            const nameB = `${b.last_name}, ${b.first_name}`.toLowerCase();
            return nameA.localeCompare(nameB);
        });

        // Add all matching students to the table
        sortedStudents.forEach(student => {
            const yearLevelText = {
                1: '1st Year',
                2: '2nd Year',
                3: '3rd Year',
                4: '4th Year',
                5: '5th Year'
            }[student.year_level] || `Year ${student.year_level}`;

            const statusClass = student.is_cleared ? 'text-green-600' : 'text-orange-600';
            const statusText = student.is_cleared ? 'Cleared' : 'Pending';

            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${student.student_id || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${student.last_name}, ${student.first_name}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${yearLevelText}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${student.course || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm ${statusClass} font-medium">${statusText}</td>
                </tr>
            `;
        });

        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        reportContent.innerHTML = html;
    }

    function exportStudentsList() {
        // Get filter values
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;

        // Show export format modal
        Swal.fire({
            title: 'Export Students List',
            html: `
                <div class="mb-4">
                    <p class="mb-2 text-left">Select export format:</p>
                    <div class="flex justify-center space-x-4">
                        <button id="pdf-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">PDF</button>
                        <button id="excel-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Excel</button>
                    </div>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Cancel',
            cancelButtonColor: '#6B7280',
            didOpen: () => {
                document.getElementById('pdf-btn').addEventListener('click', () => {
                    let url = `{% url 'admin_reports' %}?report_type=students_by_year_level&school_year=${schoolYear}&semester=${semester}&format_type=pdf`;
                    window.open(url, '_blank');
                    Swal.close();
                });

                document.getElementById('excel-btn').addEventListener('click', () => {
                    let url = `{% url 'admin_reports' %}?report_type=students_by_year_level&school_year=${schoolYear}&semester=${semester}&format_type=excel`;
                    window.open(url, '_blank');
                    Swal.close();
                });
            }
        });
    }

    function exportPendingStudentsList() {
        // Get filter values
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;

        // Show export format modal
        Swal.fire({
            title: 'Export Pending Students List',
            html: `
                <div class="mb-4">
                    <p class="mb-2 text-left">Select export format:</p>
                    <div class="flex justify-center space-x-4">
                        <button id="pdf-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">PDF</button>
                        <button id="excel-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">Excel</button>
                    </div>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Cancel',
            cancelButtonColor: '#6B7280',
            didOpen: () => {
                document.getElementById('pdf-btn').addEventListener('click', () => {
                    let url = `{% url 'admin_reports' %}?report_type=pending_students&school_year=${schoolYear}&semester=${semester}&format_type=pdf`;
                    window.open(url, '_blank');
                    Swal.close();
                });

                document.getElementById('excel-btn').addEventListener('click', () => {
                    let url = `{% url 'admin_reports' %}?report_type=pending_students&school_year=${schoolYear}&semester=${semester}&format_type=excel`;
                    window.open(url, '_blank');
                    Swal.close();
                });
            }
        });
    }

    function displayStudentNamelist() {
        // Get filter values
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const yearLevel = document.getElementById('report_year_level').value;
        const studentStatus = document.getElementById('report_student_status').value;

        // Show loading state
        const exportBtn = document.querySelector('button[onclick="displayStudentNamelist()"]');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = `
            <svg class="animate-spin w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading...
        `;
        exportBtn.disabled = true;

        // Get semester display name and exam type
        const semesterSelect = document.getElementById('report_semester');
        const semesterText = semesterSelect.options[semesterSelect.selectedIndex].text;

        // Determine if it's midterm or final based on the semester text
        const examType = semesterText.toLowerCase().includes('midterm') ? 'Midterm' : 'Final';

        // Set the title and date
        document.getElementById('namelistTitle').textContent = `SY: ${schoolYear} ${semesterText} - ${examType} Records`;
        document.getElementById('generatedDate').textContent = new Date().toLocaleString();

        // Build the URL with parameters
        let url = `/api/program-chair/students/?school_year=${schoolYear}&semester=${semester}`;

        if (yearLevel) {
            url += `&year_level=${yearLevel}`;
        }

        if (studentStatus && studentStatus !== 'all') {
            url += `&student_status=${studentStatus}`;
        }

        // Fetch student data
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    renderStudentNamelist(data.data, schoolYear, semesterText);
                } else {
                    alert('Error loading student data: ' + (data.error || 'Unknown error'));
                }

                // Reset button
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error fetching student data:', error);
                alert('Error loading student data: ' + error.message);

                // Reset button
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            });
    }

    function renderStudentNamelist(students, schoolYear, semesterText) {
        // Group students by year level
        const studentsByYear = {};
        let totalStudents = 0;
        let totalCleared = 0;
        let totalPending = 0;
        let totalNotStarted = 0;

        students.forEach(student => {
            const yearLevel = student.year_level || 'Unknown';
            if (!studentsByYear[yearLevel]) {
                studentsByYear[yearLevel] = [];
            }
            studentsByYear[yearLevel].push(student);
            totalStudents++;

            if (student.is_cleared) {
                totalCleared++;
            } else if (student.pending_offices && student.pending_offices.length > 0) {
                totalPending++;
            } else {
                totalNotStarted++;
            }
        });

        // Create the year level summary table
        const yearLevelSummary = document.getElementById('yearLevelSummary');
        let summaryHTML = `
            <table class="min-w-full divide-y divide-gray-200 border">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Level</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Students</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cleared</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Not Started</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Clearance Rate</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;

        // Sort year levels
        const sortedYears = Object.keys(studentsByYear).sort((a, b) => a - b);

        // Add rows for each year level
        sortedYears.forEach(year => {
            const yearStudents = studentsByYear[year];
            const yearTotal = yearStudents.length;
            const yearCleared = yearStudents.filter(s => s.is_cleared).length;
            const yearPending = yearStudents.filter(s => !s.is_cleared && s.pending_offices && s.pending_offices.length > 0).length;
            const yearNotStarted = yearTotal - yearCleared - yearPending;
            const clearanceRate = yearTotal > 0 ? ((yearCleared / yearTotal) * 100).toFixed(1) : '0.0';

            const yearText = {
                '1': '1st Year',
                '2': '2nd Year',
                '3': '3rd Year',
                '4': '4th Year',
                '5': '5th Year'
            }[year] || `Year ${year}`;

            summaryHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${yearText}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-500">${yearTotal}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-500">${yearCleared}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-500">${yearPending}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-500">${yearNotStarted}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-500">${clearanceRate}%</td>
                </tr>
            `;
        });

        // Add total row
        const totalClearanceRate = totalStudents > 0 ? ((totalCleared / totalStudents) * 100).toFixed(1) : '0.0';
        summaryHTML += `
            <tr class="bg-gray-50 font-semibold">
                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">Total</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-900">${totalStudents}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-900">${totalCleared}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-900">${totalPending}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-900">${totalNotStarted}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-900">${totalClearanceRate}%</td>
            </tr>
        `;

        summaryHTML += `
                </tbody>
            </table>
        `;

        yearLevelSummary.innerHTML = summaryHTML;

        // Create the student namelist
        const studentNamelist = document.getElementById('studentNamelist');
        let namelistHTML = '';

        // For each year level, create a section with students
        sortedYears.forEach(year => {
            const yearStudents = studentsByYear[year];
            const yearText = {
                '1': '1st Year',
                '2': '2nd Year',
                '3': '3rd Year',
                '4': '4th Year',
                '5': '5th Year'
            }[year] || `Year ${year}`;

            // Sort students by last name
            yearStudents.sort((a, b) => {
                if (a.last_name !== b.last_name) {
                    return a.last_name.localeCompare(b.last_name);
                }
                return a.first_name.localeCompare(b.first_name);
            });

            namelistHTML += `
                <div class="mb-6">
                    <h4 class="text-md font-semibold text-gray-800 mb-3">${yearText} Students</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 border">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                                    <th scope="col" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;

            // Add rows for each student
            yearStudents.forEach((student, index) => {
                const fullName = `${student.last_name}, ${student.first_name}`;
                let statusText = 'Not Started';
                let statusClass = 'text-gray-500';

                if (student.is_cleared) {
                    statusText = 'Cleared';
                    statusClass = 'text-green-600';
                } else if (student.pending_offices && student.pending_offices.length > 0) {
                    statusText = 'Pending';
                    statusClass = 'text-orange-500';
                }

                const rowClass = index % 2 === 0 ? '' : 'bg-gray-50';

                namelistHTML += `
                    <tr class="${rowClass} hover:bg-gray-100">
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${student.student_id || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${fullName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${student.course || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-center ${statusClass} font-medium">${statusText}</td>
                    </tr>
                `;
            });

            namelistHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });

        studentNamelist.innerHTML = namelistHTML;

        // Show the container
        document.getElementById('studentNamelistContainer').classList.remove('hidden');
    }

    function exportStudentsByYearLevel() {
        // Get filter values
        const schoolYear = document.getElementById('report_school_year').value;
        const semester = document.getElementById('report_semester').value;
        const yearLevel = document.getElementById('report_year_level').value;
        const studentStatus = document.getElementById('report_student_status').value;

        // Show loading state
        const exportBtn = document.querySelector('button[onclick="exportStudentsByYearLevel()"]');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = `
            <svg class="animate-spin w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            PDF...
        `;
        exportBtn.disabled = true;

        // Get semester display name and exam type
        const semesterSelect = document.getElementById('report_semester');
        const semesterText = semesterSelect.options[semesterSelect.selectedIndex].text;

        // Determine if it's midterm or final based on the semester text
        const examType = semesterText.toLowerCase().includes('midterm') ? 'Midterm' : 'Final';

        // Build the URL with parameters
        let url = `{% url 'admin_reports' %}?report_type=students_by_year_level&school_year=${schoolYear}&semester=${semester}&format_type=pdf&exam_type=${examType}`;

        if (yearLevel) {
            url += `&year_level=${yearLevel}`;
        }

        if (studentStatus && studentStatus !== 'all') {
            url += `&student_status=${studentStatus}`;
        }

        // Open the URL in a new tab
        window.open(url, '_blank');

        // Reset button after a delay
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }, 2000);
    }
</script>
